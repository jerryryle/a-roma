<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-Roma - All of the Aromas with None of the Rome</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Helvetica:wght@400;700&display=swap');

        body {
            font-family: 'Helvetica', sans-serif;
        }

        /* Waveform animation for music buttons */
        .waveform {
            display: inline-block;
            margin-left: 8px;
        }

        .waveform-bar {
            display: inline-block;
            width: 2px;
            height: 12px;
            background-color: currentColor;
            margin: 0 1px;
            animation: waveform-animation 1.2s ease-in-out infinite;
        }

        /* Prevent layout shift when stop button appears */
        .stop-button-container {
            min-height: 40px;
            /* Reserve space for the button */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stop-button {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }

        .stop-button.visible {
            opacity: 1;
            visibility: visible;
        }

        .waveform-bar:nth-child(1) {
            animation-delay: 0s;
        }

        .waveform-bar:nth-child(2) {
            animation-delay: 0.1s;
        }

        .waveform-bar:nth-child(3) {
            animation-delay: 0.2s;
        }

        .waveform-bar:nth-child(4) {
            animation-delay: 0.3s;
        }

        .waveform-bar:nth-child(5) {
            animation-delay: 0.4s;
        }

        @keyframes waveform-animation {

            0%,
            40%,
            100% {
                transform: scaleY(0.4);
            }

            20% {
                transform: scaleY(1);
            }
        }
    </style>
</head>

<body class="bg-white min-h-screen">
    <!-- Top Banner -->
    <div class="border-b-4" style="background-color: #fffdd5; border-bottom-color: #eceac5;">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-center space-x-4">
                <!-- Italian Flag -->
                <div class="w-16 h-12 rounded shadow-lg overflow-hidden">
                    <img src="/static/flag_of_italy.svg" alt="Italian Flag" class="w-full h-full object-cover">
                </div>

                <!-- Welcome SVG -->
                <div class="flex-shrink-0">
                    <img src="/static/welcome_to_aroma.svg" alt="Welcome to A-Roma" class="h-16 md:h-20 lg:h-24">
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-900 mb-6">
                Help Ryan relive his vacation with a whiff of
            </h2>
        </div>

        <!-- Aroma Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 max-w-6xl mx-auto" id="aroma-grid">
            <!-- Aroma cards will be generated here -->
        </div>

        <!-- Music Controls -->
        <div class="mt-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-900 mb-6">
                    and some Italian music to go with it
                </h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 max-w-6xl mx-auto" id="music-grid">
                <!-- Music buttons will be generated here -->
            </div>

            <!-- Volume Control -->
            <div class="mt-6 text-center">
                <div class="bg-gray-100 rounded-lg p-4 shadow-lg inline-block">
                    <h3 class="text-lg font-bold text-gray-900 mb-3">Volume Control</h3>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">0%</span>
                        <input type="range" id="volume-slider" min="0" max="100" value="70"
                            class="w-32 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                            oninput="updateVolume(this.value)">
                        <span class="text-sm text-gray-600">100%</span>
                        <span id="volume-display" class="text-sm font-bold text-gray-900">70%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection for real-time updates
        let ws = null;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = function () {
                console.log('WebSocket connected');
            };

            ws.onmessage = function (event) {
                const data = JSON.parse(event.data);
                if (data.type === 'fan_status') {
                    updateFanStatus(data.data);
                } else if (data.type === 'music_status') {
                    updateMusicStatus(data.data);
                }
            };

            ws.onclose = function () {
                console.log('WebSocket disconnected, attempting to reconnect...');
                setTimeout(connectWebSocket, 1000);
            };

            ws.onerror = function (error) {
                console.error('WebSocket error:', error);
            };
        }

        function updateFanStatus(fanStatus) {
            const aromaNames = ['Fine Italian Leather', 'Artisan Bread', 'Espresso', 'Garlic'];

            for (let i = 0; i < 4; i++) {
                const fanKey = `fan_${i}`;
                const fan = fanStatus[fanKey];
                const image = document.getElementById(`image-${i}`);
                const progress = document.getElementById(`progress-${i}`);
                const stopButton = document.getElementById(`stop-button-${i}`);
                const stopTime = document.getElementById(`stop-time-${i}`);

                // Infer active state from remaining_seconds
                const isActive = fan.remaining_seconds > 0;

                if (isActive && fan.total_seconds > 0) {
                    const progressPercent = (fan.remaining_seconds / fan.total_seconds) * 100;

                    // Remove grayscale filter based on progress
                    image.style.filter = `grayscale(${100 - progressPercent}%)`;

                    // Show progress overlay from left to right
                    progress.style.opacity = '1';
                    progress.style.background = `linear-gradient(to right, rgba(156, 163, 175, 0.8) ${100 - progressPercent}%, transparent ${100 - progressPercent}%)`;

                    // Show stop button and update time
                    stopButton.classList.add('visible');
                    stopTime.textContent = fan.remaining_seconds;
                } else {
                    // Reset to grayscale when inactive
                    image.style.filter = 'grayscale(100%)';
                    progress.style.opacity = '0';

                    // Hide stop button when inactive
                    stopButton.classList.remove('visible');
                }
            }
        }

        // Configuration data
        const aromaData = [
            { id: 0, name: "Fine Italian Leather", image: "/static/leather.jpg", bgClass: "bg-blue-gray-100" },
            { id: 1, name: "Artisan Bread", image: "/static/bread.jpg", bgClass: "bg-olive-100" },
            { id: 2, name: "Espresso", image: "/static/espresso.jpg", bgClass: "bg-yellow-100" },
            { id: 3, name: "Garlic", image: "/static/garlic.jpg", bgClass: "bg-red-100" }
        ];

        const musicData = [
            { id: 1, name: "Tarantella Napoletana" },
            { id: 2, name: "Mambo Italiano" },
            { id: 3, name: "Luna Mezzo Mare" },
            { id: 4, name: "That's Amore" }
        ];

        // Generate HTML for aroma cards
        function generateAromaCards() {
            const grid = document.getElementById('aroma-grid');
            grid.innerHTML = aromaData.map(aroma => `
                <div class="bg-gray-100 rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer"
                    onclick="activateFan(${aroma.id})">
                    <div class="h-48 ${aroma.bgClass} relative overflow-hidden">
                        <img src="${aroma.image}" alt="${aroma.name}"
                            class="w-full h-full object-cover grayscale transition-all duration-300" id="image-${aroma.id}">
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-transparent to-gray-400 opacity-0 transition-opacity duration-300"
                            id="progress-${aroma.id}"></div>
                    </div>
                    <div class="p-4 text-center">
                        <h3 class="text-lg font-bold text-gray-900 mb-2">${aroma.name}</h3>
                        <div class="stop-button-container">
                            <button id="stop-button-${aroma.id}"
                                class="stop-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200"
                                onclick="event.stopPropagation(); stopFan(${aroma.id})">
                                Stop (<span id="stop-time-${aroma.id}">0</span>)
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Generate HTML for music buttons
        function generateMusicButtons() {
            const grid = document.getElementById('music-grid');
            grid.innerHTML = musicData.map(song => `
                <div class="bg-gray-100 rounded-lg p-4 text-center shadow-lg">
                    <h3 class="text-lg font-bold text-gray-900 mb-3">${song.name}</h3>
                    <button id="music-button-${song.id}"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200"
                        onclick="startMusic(${song.id})">
                        Play
                        <div class="waveform hidden">
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                        </div>
                    </button>
                </div>
            `).join('');
        }

        // Initialize page when DOM loads
        document.addEventListener('DOMContentLoaded', async function () {
            // Generate HTML dynamically
            generateAromaCards();
            generateMusicButtons();

            // Get initial fan status before connecting WebSocket
            await getInitialFanStatus();
            // Get initial music status before connecting WebSocket
            await getInitialMusicStatus();
            // Then connect WebSocket for real-time updates
            connectWebSocket();
        });

        async function getInitialFanStatus() {
            try {
                const response = await fetch('/api/fan/status');
                if (response.ok) {
                    const fanStatus = await response.json();
                    updateFanStatus(fanStatus);
                } else {
                    console.error('Failed to get initial fan status:', response.status);
                }
            } catch (error) {
                console.error('Error getting initial fan status:', error);
            }
        }

        async function activateFan(fanId) {
            try {
                const response = await fetch(`/api/fan/${fanId}/on?duration_seconds=120`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Fan activated:', result.message);
                } else {
                    console.error('Failed to activate fan:', response.status);
                }
            } catch (error) {
                console.error('Error activating fan:', error);
            }
        }

        async function stopFan(fanId) {
            try {
                const response = await fetch(`/api/fan/${fanId}/off`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Fan stopped:', result.message);
                } else {
                    console.error('Failed to stop fan:', response.status);
                }
            } catch (error) {
                console.error('Error stopping fan:', error);
            }
        }

        async function getInitialMusicStatus() {
            try {
                const response = await fetch('/api/music/status');
                if (response.ok) {
                    const musicStatus = await response.json();
                    updateMusicStatus(musicStatus);
                } else {
                    console.error('Failed to get initial music status:', response.status);
                }
            } catch (error) {
                console.error('Error getting initial music status:', error);
            }
        }

        function updateMusicStatus(musicStatus) {
            const currentlyPlaying = musicStatus.currently_playing;
            const volume = musicStatus.volume;

            // Update all music buttons
            for (let i = 1; i <= 4; i++) {
                const button = document.getElementById(`music-button-${i}`);
                const songId = i.toString();
                const waveform = button.querySelector('.waveform');

                if (currentlyPlaying === songId) {
                    // This song is playing, show stop button with waveform
                    button.innerHTML = 'Stop<div class="waveform"><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div></div>';
                    button.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200';
                    button.onclick = () => stopMusic();
                } else {
                    // This song is not playing, show play button without waveform
                    button.innerHTML = 'Play<div class="waveform hidden"><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div></div>';
                    button.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200';
                    button.onclick = () => startMusic(songId);
                }
            }

            // Update volume slider and display
            if (volume !== undefined) {
                const volumeSlider = document.getElementById('volume-slider');
                const volumeDisplay = document.getElementById('volume-display');
                const volumePercent = Math.round(volume * 100);

                volumeSlider.value = volumePercent;
                volumeDisplay.textContent = volumePercent + '%';
            }
        }

        async function startMusic(songId) {
            try {
                const response = await fetch(`/api/music/start/${songId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Music started:', result.message);
                } else {
                    console.error('Failed to start music:', response.status);
                }
            } catch (error) {
                console.error('Error starting music:', error);
            }
        }

        async function stopMusic() {
            try {
                const response = await fetch('/api/music/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Music stopped:', result.message);
                } else {
                    console.error('Failed to stop music:', response.status);
                }
            } catch (error) {
                console.error('Error stopping music:', error);
            }
        }

        async function updateVolume(volumePercent) {
            try {
                const volume = volumePercent / 100; // Convert percentage to 0.0-1.0 range

                const response = await fetch('/api/music/volume', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ volume: volume }),
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Volume updated:', result.message);

                    // Update the display immediately for responsive UI
                    const volumeDisplay = document.getElementById('volume-display');
                    volumeDisplay.textContent = volumePercent + '%';
                } else {
                    console.error('Failed to update volume:', response.status);
                }
            } catch (error) {
                console.error('Error updating volume:', error);
            }
        }
    </script>
</body>

</html>